// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  FAMILY_ADMIN
  MEMBER
  VIEWER
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum AccountType {
  CASH
  BANK
  CARD
  SAVINGS
}

enum CategoryType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum BudgetPeriodType {
  WEEKLY
  MONTHLY
  YEARLY
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ImportFileType {
  CSV
  XLSX
  XLS
  OFX
  QFX
  QIF
}

// Models
model Family {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users        User[]
  accounts     Account[]
  categories   Category[]
  transactions Transaction[]
  budgets      Budget[]
  invitations  FamilyInvitation[]
  importBatches ImportBatch[]

  @@map("families")
}

model User {
  id           String     @id @default(uuid())
  familyId     String     @map("family_id")
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String
  role         UserRole
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  isDeleted    Boolean    @default(false) @map("is_deleted")
  deletedAt    DateTime?  @map("deleted_at")

  // Relations
  family              Family               @relation(fields: [familyId], references: [id], onDelete: Cascade)
  transactions        Transaction[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  sentInvitations     FamilyInvitation[]   @relation("InvitedBy")
  importBatches       ImportBatch[]

  @@index([email])
  @@map("users")
}

model Account {
  id             String      @id @default(uuid())
  familyId       String      @map("family_id")
  name           String
  type           AccountType
  currency       String      @db.VarChar(3)
  openingBalance Decimal     @map("opening_balance") @db.Decimal(15, 2)
  isActive       Boolean     @default(true) @map("is_active")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  isDeleted      Boolean     @default(false) @map("is_deleted")
  deletedAt      DateTime?   @map("deleted_at")
  version        Int         @default(1)

  // Relations
  family               Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  transactions         Transaction[] @relation("AccountTransactions")
  transferTransactions Transaction[] @relation("TransferAccountTransactions")
  budgets              Budget[]

  @@index([familyId])
  @@map("accounts")
}

model Category {
  id        String       @id @default(uuid())
  familyId  String       @map("family_id")
  name      String
  type      CategoryType
  parentId  String?      @map("parent_id")
  color     String
  icon      String
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  isDeleted Boolean      @default(false) @map("is_deleted")
  deletedAt DateTime?    @map("deleted_at")
  version   Int          @default(1)

  // Relations
  family       Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  parent       Category?     @relation("CategorySubcategories", fields: [parentId], references: [id], onDelete: SetNull)
  children     Category[]    @relation("CategorySubcategories")
  transactions Transaction[]
  budgets      Budget[]

  @@index([familyId])
  @@map("categories")
}

model Transaction {
  id                String          @id @default(uuid())
  familyId          String          @map("family_id")
  accountId         String          @map("account_id")
  categoryId        String          @map("category_id")
  userId            String          @map("user_id")
  type              TransactionType
  amount            Decimal         @db.Decimal(15, 2)
  currency          String          @db.VarChar(3)
  date              DateTime
  payee             String
  notes             String          @default("")
  transferAccountId String?         @map("transfer_account_id")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  isDeleted         Boolean         @default(false) @map("is_deleted")
  deletedAt         DateTime?       @map("deleted_at")
  version           Int             @default(1)

  // Relations
  family          Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  account         Account  @relation("AccountTransactions", fields: [accountId], references: [id], onDelete: Cascade)
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  user            User     @relation(fields: [userId], references: [id], onDelete: Restrict)
  transferAccount Account? @relation("TransferAccountTransactions", fields: [transferAccountId], references: [id], onDelete: SetNull)

  @@index([familyId, date])
  @@index([accountId])
  @@index([categoryId])
  @@index([userId])
  @@map("transactions")
}

model Budget {
  id         String           @id @default(uuid())
  familyId   String           @map("family_id")
  categoryId String           @map("category_id")
  accountId  String?          @map("account_id")
  periodType BudgetPeriodType @map("period_type")
  amount     Decimal          @db.Decimal(15, 2)
  startDate  DateTime         @map("start_date")
  endDate    DateTime         @map("end_date")
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")
  version    Int              @default(1)
  isDeleted  Boolean          @default(false) @map("is_deleted")
  deletedAt  DateTime?        @map("deleted_at")

  // Relations
  family   Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  account  Account?  @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@map("budgets")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model LoginAttempt {
  id        String   @id @default(uuid())
  email     String
  ipAddress String   @map("ip_address")
  success   Boolean
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@map("password_reset_tokens")
}

enum InviteRole {
  MEMBER
  VIEWER
}

model FamilyInvitation {
  id              String      @id @default(uuid())
  familyId        String      @map("family_id")
  invitedByUserId String      @map("invited_by_user_id")
  email           String
  role            InviteRole
  tokenHash       String      @map("token_hash")
  expiresAt       DateTime    @map("expires_at")
  acceptedAt      DateTime?   @map("accepted_at")
  revokedAt       DateTime?   @map("revoked_at")
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  family    Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  invitedBy User   @relation("InvitedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([tokenHash])
  @@index([familyId])
  @@map("family_invitations")
}

model ImportBatch {
  id            String         @id @default(uuid())
  familyId      String         @map("family_id")
  userId        String         @map("user_id")
  filename      String
  fileType      ImportFileType @map("file_type")
  status        ImportStatus   @default(PENDING)
  totalRows     Int            @default(0) @map("total_rows")
  importedCount Int            @default(0) @map("imported_count")
  skippedCount  Int            @default(0) @map("skipped_count")
  errorCount    Int            @default(0) @map("error_count")
  errorLog      String?        @map("error_log") @db.Text
  columnMapping Json?          @map("column_mapping")
  createdAt     DateTime       @default(now()) @map("created_at")
  completedAt   DateTime?      @map("completed_at")

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([familyId])
  @@index([userId])
  @@map("import_batches")
}
